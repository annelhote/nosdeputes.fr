<?php

/**
 * Texteloi
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    cpc
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Texteloi extends BaseTexteloi
{

  protected $cpt = 0;

  public function getLink() {
    sfProjectConfiguration::getActive()->loadHelpers(array('Url'));
    return url_for('@document?id='.$this->id);
  }

  public function __toString() {
    $str = substr($this->getExtract(), 0, 250);
    if (strlen($str) == 250) {
      $str .= '...';
    } else if (!$str) $str = "";
    return $str;
  }

  public function getPersonne() {
    $auteurs = $this->getAuteurs();
    if (!$auteurs) return "";
    return $auteurs[0]['nom'];
  }

  public function getAmendements($help = 0) {
    return self::getAmdmts($this->type, $this->id, $help);
  }

  public static function getAmdmts($type, $numero, $help = 0) {
    if (!($type === "Rapport" && $help) && !preg_match('/(Motion|Projet de loi|Proposition de loi|Proposition de résolution|Texte de la commission)/', $type))
      return 0;
    $res = count(Doctrine::getTable('Amendement')->createQuery('a')
      ->where('texteloi_id = ?', $numero)
      ->fetchArray());
    return $res;
  }

  public function getSection() {
    if ($this->id_dossier_institution)
      $section = Doctrine::getTable('Section')->findOneByIdDossierInstitution($this->id_dossier_institution);
    if (!isset($section) || !$section) $section = Doctrine_Query::create()
      ->select('s.id')
      ->from('Section s, Tagging ta, Tag t')
      ->where('s.section_id = s.id')
      ->andWhere('ta.taggable_id = s.id')
      ->andWhere('ta.tag_id = t.id')
      ->andWhere('ta.taggable_model = ?', "Section")
      ->andWhere('t.name = ?', "loi:numero=".preg_replace('/^(\d{8}-\d{3}).*$/', '\\1', $this->id))
      ->fetchOne();
    return $section;
  }

  public function setDossier($urldossier) {
    $this->id_dossier_institution = $urldossier;
    $section = Doctrine::getTable('Section')->findOneByIdDossierInstitution($urldossier);
    if ($section) {
   # cela parait plus cohérent que les dossiers apparaissent comme récemment modifiés uniquement s'ils sont discutés et pas si un nouveau rapport vient les compléter je pense mais on peut envisager de le mettre tout de même si c utile pour solr par exemple
   #   $section->setMaxDate($this->date);
   #   $section->save();
 #print "$section->id, $this->id_dossier_institution\n";
      return true;
    }
    $sections = Doctrine_Query::create()
      ->select('s.id')
      ->from('Section s, Tagging ta, Tag t')
      ->where('s.section_id = s.id')
      ->andWhere('ta.taggable_id = s.id')
      ->andWhere('ta.tag_id = t.id')
      ->andWhere('ta.taggable_model = ?', "Section")
      ->andWhere('t.name = ?', "loi:numero=".preg_replace('/^(\d{8}-\d{3}).*$/', '\\1', $this->id))
      ->fetchArray();
    $res = count($sections);
    if ($res == 0) {
     // print "DEBUG : Pas de dossier trouvé pour le texte $this->id\n";
     return false;
    } else if ($res == 1) {
      $section = Doctrine::getTable('Section')->find($sections[0]['id']);
      $section->id_dossier_institution = $urldossier;
   # voir plus haut
   #  $section->setMaxDate($this->date);
      $section->save();
     #print "$section->id, $this->id_dossier_institution\n";
      return true;
    } else {
     echo "\nWARNING $this->source : Plusieurs dossiers trouvés pour le texte $this->id de type $this->type\n";
     return false;
    }
  }

  public function setAuteurs($signataires) {
    $debug=0; $debug2=0;
   // $debug=1; // $debug2=1;
    $this->signataires = $signataires;
   //Set signataires, auteurs via PArlemnaitreTexteDocu et Organisme
    $orga = null;
    $sexe = null;
    $fonction = null;
    $signataires = preg_replace("/(Auteur|Cosignataire|Rapporteur), /", "\\1#", $signataires);
    if ($debug2) echo $this->source." : ".$signataires."\n";
    $signataires = preg_split('/#/', $signataires);
    foreach ($signataires as $senateur) {
      if (preg_match('/^(M[\.mle]+)/', $senateur, $match))
        continue;
      if (preg_match('/^(.*)(\set|,)?( apparentés)?(\set|,)?( rattachés)?\s+(Auteur|Cosignataire|Rapporteur)/', $senateur, $match)) {
        $orga = trim($match[1]);
        $organisme = Doctrine::getTable('Organisme')->findOneByNomType($orga, 'parlementaire');
        if ($organisme) {
          $this->setOrganisme($organisme);
          if (!($this->type_details)) {
            $this->type_details = "de l";
            if (preg_match('/^[aeiouyh]/i', $organisme->nom))
              $this->type_details .= "'";
            else if (preg_match('/^comit/i', $organisme))
              $this->type_details .= "e ";
            else $this->type_details .= "a ";
            $this->type_details .= $organisme->nom;
          }
          $orga = $organisme->nom;
        } else {
          $groupe = Doctrine::getTable('Organisme')->findOneByNomType($orga, 'groupe');
          if ($groupe) {
            $this->setOrganisme($groupe);
            $orga = " pour le groupe ".$orga;
          }
        }
        if ($debug) echo "DEBUG Organisme: $orga -> ".$organisme->nom."\n";
        break;
      }
    }
    foreach ($signataires as $senateur) {
      if (preg_match('/^(M[\.mle]+)\s+(.*)\s+(Auteur|Cosignataire|Rapporteur)/', $senateur, $match)) {
        if (preg_match('/M[ml]/', $match[1]))
          $sexe = 'F';
        else $sexe = 'H';
        $nom = $match[2];
        $fonction = $match[3];
        if (preg_match('/^(.*)\((.*)\)/', $nom, $match)) {
          $nom = trim($match[1]);
          $circo = preg_replace('/\s/', '-', ucfirst(trim($match[2])));
        } else $circo = null;
        if (preg_match('/(ministre|[eéÉ]tat|président|haut-commissaire)/i', $nom)) {
          if ($debug) print "WARN: Skip auteur ".$nom." for ".$this->source."\n";
          continue;
        }
        $nom = ucfirst($nom);
        if ($debug2) echo $nom."//".$sexe."//".$orga."//".$circo."//".$fonction." => ";
        $senateur = Doctrine::getTable('Parlementaire')->findOneByNomSexeGroupeCirco($nom, $sexe, null, $circo, $this);
        if (!$senateur) print "\nWARNING: Auteur introuvable in ".$this->source." : ".$nom." // ".$sexe." // ".$orga."//".$fonction."\n";
        else {
          if ($debug2) echo $senateur->nom."\n";
          $this->addParlementaire($senateur, $fonction, $orga);
        }
      }
    }
  }

  public function addParlementaire($senateur, $fonction, $organisme = 0) {
    foreach(Doctrine::getTable('ParlementaireTexteloi')->createQuery('pa')->select('parlementaire_id')->where('texteloi_id = ?', $this->id)->fetchArray() as $parldt) if ($parldt['parlementaire_id'] == $senateur->id) return true;

    $pd = new ParlementaireTexteloi();
    $pd->_set('Parlementaire', $senateur);
    $pd->_set('Texteloi', $this);
    if ($fonction === "Auteur")
      $pd->_set('importance', 1);
    else if ($fonction === "Rapporteur")
      $pd->_set('importance', 3);
    else if ($fonction === "Cosignataire")
      $pd->_set('importance', 5);
    else print "ERREUR: fonction mauvaise pour ".$senateur->nom." : ".$fonction;
    if ($organisme && $fonction != "Cosignataire") {
      if (!(preg_match('/^ pour le groupe/', $organisme))) {
        $fonction .= " pour l";
        if (preg_match('/^[aeiouyh]/i', $organisme))
          $fonction .= "'";
        else if (preg_match('/^comit/i', $organisme))
          $fonction .= "e ";
        else $fonction .= "a ";
      }
      $fonction .= $organisme;
      $fonction = preg_replace("/(pour la (mission d'information|délégation|commission d'enquête)) .*$/i", "$1", $fonction);
    }
    $pd->_set('fonction', $fonction);
    if ($pd->save()) {
      return true;
    } else return false;
  }

  public function getTypeString() {
    $str = "ce";
    if (preg_match('/(propos|lettre|motion)/i', $this->type))
      $str .= "tte";
    else if ($this->type === "Avis")
      $str .= "t";
    $str .= " ".strtolower($this->type);
    return $str;
  }

  public function getAuteurs() {
    return Doctrine_Query::create()
      ->select('p.*, pt.fonction')
      ->from('Parlementaire p')
      ->leftJoin('p.ParlementaireTexteloi pt')
      ->where('pt.importance < 4')
      ->andWhere('pt.texteloi_id = ?', $this->id)
      ->orderBy('pt.importance, p.sexe, p.nom')
      ->execute();
  }

  public function getCosignataires() {
    return Doctrine_Query::create()
      ->select('p.*, pt.fonction')
      ->from('Parlementaire p')
      ->leftJoin('p.ParlementaireTexteloi pt')
      ->where('pt.importance >= 4')
      ->andWhere('pt.texteloi_id = ?', $this->id)
      ->orderBy('pt.importance, p.sexe, p.nom')
      ->execute();
  }

  public function getSignatairesString() {
    $str = preg_replace('/ (Cosignataire|Auteur|Rapporteur)/', '', $this->signataires);
    return $str;
  }

  public function getCommission() {
    if ($this->type === "Texte de la commission") {
      $rap = Doctrine::getTable('Texteloi')->find("$this->numero");
      if ($rap) return $rap->getOrganisme();
      return null;
    }
    return $this->getOrganisme();
  }

  public static function staticShortTitre($id, $annexe, $type) {
    $str = "";
    if (preg_match('/a([1-9]\d*)/', $annexe, $ann)) {
      $str .= "Annexe N° ".$ann[1]." ";
      if ($type === "Avis")
        $str .= "à l'";
      else $str .=  "au ";
    }
    $str .= $type." N°&nbsp;";
    if (preg_match('/^(\d{4})(\d{4})-(TAS)?(\d{3})/', $id, $match))
      $str .= preg_replace('/^0+/', '', $match[4])." (".$match[1].'-'.$match[2].")";
    else $str .= $id;
    if (preg_match('/t(\d+)/', $annexe, $tom)) {
      $str .= " (Tome ".$tom[1];
      if (preg_match('/v(\d+)/', $annexe, $vol))
        $str .= " - volume ".$vol[1];
      $str .= ")";
    }
    return $str;
  }

  public function getShortTitre() {
    return self::staticShortTitre($this->id, $this->annexe, $this->type);
  }


  public function getTitre() {
    $str = $this->getDetailsTitre();
    if ($str)
      return $this->getShortTitre()." ".$str;
    return $this->getShortTitre();
  }

  public function getDetailsTitre() {
    $str = "";
    if ($this->type_details) // && !preg_match('/'.$this->type_details.'/', $this->_get('titre')))
      $str .= " ".$this->type_details;
    if ($this->_get('titre'))
      $str .= (preg_match('/^[A-ZÉÈÊËÀÂÎÏÔÛÜÇ]/', $this->_get('titre')) ? " - " : " ").$this->_get('titre');
    $str = preg_replace('/^,\s*/', '', preg_replace('/\s*,\s*/', ', ', $str));
    return $str;
  }

  public function getTitreCommission() {
    $str = $this->getShortTitre();
    if ($this->_get('titre'))
      $str .= " ".$this->_get('titre');
    $str = preg_replace('/^,\s*/', '', preg_replace('/\s*,\s*/', ', ', $str));
    return $str;
  }

  public function getContenu() {
    $c = $this->_get('contenu');
    $t = base64_decode($c);
    $c = '';
    $file = tempnam(sys_get_temp_dir(), 'textloi');
    $temp = fopen($file, 'w');
    fwrite($temp, $t);
    fclose($temp);
    $temp = gzopen($file, 'r');
    $z = gzgets($temp, memory_get_usage(true)*2/3);
    gzclose($temp);
    unlink($file);
    return $z;
  }

  public function setContenu($c) {
    $file = tempnam(sys_get_temp_dir(), 'textloi');
    $temp = gzopen($file, 'w');
    gzwrite($temp, $c);
    gzclose($temp);
    $ret = $this->_set('contenu', base64_encode(file_get_contents($file)));
    unlink($file);
    return $ret;
  }

  public function getExtract() {
    $sub = substr(strip_tags($this->contenu), 0, 30000);
    if (preg_match('/^.*EXPOS(É|E) DES MOTIFS\s*(.*)$/i', $sub, $match))
      $str = $match[2];
    else {
      $str = preg_replace('/^.*(mesdames)/i', '\\1', $sub);
      if (!preg_match('/^mesdames/i', $str) && preg_match('/^.*introduction(.*)$/i', $sub, $match))
        $str = $match[1];
      else return null;
    }
    $str2 = substr($str, 0, 1000);
    $str2 = preg_replace('/\s+[^\s]*$/', '', $str2);
    if (strlen($str) > 1000) {
      $str2 .= '...';
    } else if (!$str) $str2 = "";
    return $str2;
  }

  public function indexInSolr() {
    $this->getListener()->get("Solr")->addSolrCommand($this);
  }

}
